% ------------------------------------------------------------------------------
\section{Design Considerations} \label{design}

This section begins with a discussion about the solar cell and the energy storage unit used on both proposed circuits. 
These two circuits were designed, tested and compared aiming to answer the questions risen on section \ref{fund}.
The first circuit is based on the idea of directly coupling the battery and the solar panel. This approach was chosen due to its simplicity and proved efficiency~\cite{Raghunathan:2005}. The second circuit has one of the most suitable MPPT IC for low power wireless platforms available in the market~\cite{spv1040:2012}.

\subsection{Solar Cell and Energy Storage Unit} \label{scell_stunit}

The relation between the solar cell and the energy storage unit is a crucial issue for a directly coupled solar energy harvesting circuit. This highlights the need of working as close as possible to the MPP, in order to extract the maximum amount of energy available. For the first circuit, which has no maximum power point tracker, the battery operating voltage should be as close as possible to the $V_{MPP}$ for the selected solar cell. 

The two available technologies to store energy, in a rechargeable way, are batteries and super capacitors. Although super capacitors are improving, they are not  recommended for solar harvesting circuits yet due to intrinsic leakage, losses on parasitic paths in the external circuitry \cite{Raghunathan:2005}, and, mainly, low energy density. Among all the battery technologies available (e.g., Sealed Lead Acid, Nickel Cadmium, Nickel Metal Hydride, Lithium based), the Nickel Metal Hydride (NiMH) was chosen mainly for the low complexity on the recharging circuit and the absence of memory effect. Consequently, the system is powered by two common AA NiMH batteries with a nominal charge capacity of $2100~mA$.  

% Change values and dates on this paragraph and in table!!!!!!!!!!!!!!!!!!!!!!!!
% !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
The PV module is composed by two $2~V-100~mA$ solar cells measuring $55$~x~$45~mm$ connected in-serie. The solar panelâ€™s characterization curves were plotted (Figures \ref{fig:cv_cha} and \ref{fig:pv_cha}) based on data collected outdoor, on March 08, 2012 at 1:15 pm, with an average irradiance of $954~W/m^{2}$. The goal of the test was to find out the solar panel's open circuit voltage ($V_{OC}$), short circuit current ($I_{SC}$) and $V_{MPP}$ in a real scenario. Table \ref{tab:solar_cha} shows the obtained values.
% !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

\fig{0.21}{cv_cha}{Solar panel characterization carried outside - current-voltage curve}
\fig{0.21}{pv_cha}{Solar panel characterization carried outside - power-voltage curve}

\begin{table}[!t]
\renewcommand{\arraystretch}{1.3}
\caption{Solar Panel Measured Parameters}
\label{tab:solar_cha}
\centering
\begin{tabular}{c||c}
\hline
\bfseries Parameter & \bfseries Measured Value	\\
\hline\hline
$V_{OC}$ 		& $1.98~V$							\\
$I_{SC}$   		& $101.92~mA$  						\\
$V_{MPP}$		& $1.55~V$   						\\
\hline
\end{tabular}
\end{table}
 
\subsection{Adaptation for Low Power Wireless Platforms} \label{adaptation}

In order to understand the design considerations made for the directly coupled circuit, it is essential to know some of the low power wireless platforms' characteristics.
Table~\ref{tab:mcu_cha} shows three different examples that have motivated the changes applied to Helimote's~\cite{Raghunathan:2005} circuit.
They are typical Platform-in-Package (PiP) which features a $2.4~GHz$ radio frequency transceiver.
As shown in Table~\ref{tab:mcu_cha}, all these PiPs may operate with voltages lower than $3.3~V$.
Therefore, there is no need for the step-up converter used in Heliomote's project.
The new generation of PiPs normally operates at $1.8~V$, having a built-in buck regulator.
Hence, the harvesting circuit efficiency is improved by eliminating the step-up converter.

\begin{table}[!t]
\renewcommand{\arraystretch}{1.3}
\caption{Wireless MCU's Electrical Characteristics}
\label{tab:mcu_cha}
\centering
\begin{tabular}{l||l||l||l}
\hline
\bfseries Model & \bfseries Manufacturer & \bfseries Voltage	& \bfseries Current* \\
\hline\hline
MC1322	 		& Freescale Semiconductor 	& $2V-3.6V$					& $29mA$				\\
CC2530   		& Texas Instruments			& $2V-3.6V$					& $29mA$				\\
STM32W			& STMicroelectronics		& $2.1V-3.6V$				& $31mA$				\\
\hline
\multicolumn{4}{l}{* current drain in transmit mode.}
\end{tabular}
\end{table}

\subsection{Directly Coupled Circuit Design} \label{dccirc_design}

This harvesting circuit is planned to charge the NiMH batteries until it reaches a predefined threshold voltage. This voltage is set by external resistors in a voltage monitor (ICL7665). The threshold voltage selected was based on the charging behavior of the NiMH battery provided by the manufacturer (see Figure \ref{fig:bat_cha}). This battery is considered fully charged when it reaches a voltage around $1.45~V$ ($0.1~C$ curve). The selected threshold voltage was $2.9~V$, since the two AA cells were arranged in-serie. An analog switch short circuits the solar panel to the ground when this value is reached. The overvoltage signal provided by the ICL7665 controls the analog switch. This prevents battery overcharges. A normally open (MAX4614) analog switch were used instead of a normally closed one. Hence, if the initial battery voltage is bellow $2~V$ it is charged by the solar panel instead of being short circuited to the ground as in the case of using a normally closed one. 

The circuit must also take care of the undercharge situation. There are two different reasons to avoid that. First, there is a minimum voltage threshold from which batteries do not operate properly. In this case, it is recommended to disconnect the load in order to avoid battery degradation. The second reason is that the input voltage of the wireless MCU's should not be lower than $2~V$. Thus, the under voltage pin of the ICL7665 is connected to a transistor. Then, when the battery voltage drops below $2.1~V$ the transistor is opened, disconnecting the mote. A simplified block diagram of the harvesting circuit is shown in Figure \ref{fig:circ_diagram}.

Besides the already mentioned features, the circuit has a battery monitor (DS2438). This IC communicates through a protocol called 1-Wire. It provides the battery's information (battery voltage, battery current, remaining capacity and temperature) that may be used by an energy-aware task scheduler. The DS2438 also has an integrated current accumulator, which informs the total current going in and out of the battery.

\fig{0.26}{bat_cha}{Charging curves for AA Nickel Metal Hidryde battery \cite{Panasonic:2000}.}
\fig{0.45}{circ_diagram}{Simplified block diagram of the directly coupled solar harvesting circuit.}

\subsection{MPPT IC Circuit Design} \label{iccirc_design}

Before describing the characteristics of the energy harvesting circuit based on the MPPT IC, some remarks regarding the system should be done. In order to allow a fair comparison between both circuits, the solar cells used for this circuit were the same used for the directly coupled one. This provides to both systems nearly the same power input. The batteries were also maintained (two AA NiMH $2100~mA$ rechargeable batteries).

Some MPPT ICs from different manufacturers are available in the market~\cite{spv1040:2012},~\cite{sm72442:2012}~\cite{mpt612:2010}.
Among these options, the SPV1040 from STMicroelectronics is one of the most suitable for low power applications.
It is a low power (maximum output power of 3W), low voltage, monolithic step-up converter. It is provided with three distinct operation modes, which allows the IC to work from 0.3 V to 5.5 V~\cite{spv1040:2012}.

The first design consideration occurs in the system level, which is concerning the voltage for charging the batteries (around $2.9~V$). It means that the two solar cells should not be arranged in-serie anymore, since the SPV1040 is a step-up converter. In order to maintain the same input power than the directly coupled circuit, the two $2.0~V$ solar cells were connected in parallel. Therefore, the MPPT IC converts the input voltage (from $0.3~V$ to $2~V$) to the batterie's charging voltage level (maximum set to $2.9~V$).

The basis for the following design considerations was the application note provide by STMicroelectronics~\cite{an3319:2012}.     
The pins MPP-SET and XSHUT were connected to the solar panel through a $1K~\Omega$ resistor. A $10m~\Omega$ (1\%) was the output current sense resistor. The battery monitor circuit is the same used in the directly coupled circuit. Figure \ref{fig:mppt_ic_diagram}~and~\ref{fig:mppt_block} show, respectively, the simplified block diagram of the circuit and the MPPT block schematic.

\fig{0.45}{mppt_ic_diagram}{Simplified block diagram of the MPPT IC based solar harvesting circuit.}
\fig{0.41}{mppt_block}{Simplified schematic of the MPPT block.}

% ------------------------------------------------------------------------------